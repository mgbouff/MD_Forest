---
title: "Updated Data"
author: "Marie Bouffard"
date: '2022-04-12'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Attach packages
library(tidyverse)
library(janitor)
library(here)
library(readxl)
library(scales)
library(stringr)
library(naniar)
library(RColorBrewer)
library(xlsx)
library(ggrepel)

#---------------------------------------
# Read in Data
#---------------------------------------

# Task 1 
#---------------------------------------

# 1A
# ---current lu---
# Read in 2018 state data
state_forest_raw <- read.csv(here("Data", "New", "1a_State.csv")) %>% 
  clean_names()

# Read in 2018 county data
county_forest_raw <- read.csv(here("Data", "New", "1a_County.csv")) %>% 
  clean_names()

# Old county data with population
county_pop <- read.csv(here("Data", "1a_County_short_2018.csv")) %>% 
  clean_names() %>% 
  select(county, x2020_pop)

# Read in 2018 county forest tree cover data
county_tc_forest_raw <- read_xlsx(here("Data", "New", "Figure4_PercentTC_TableToExcel.xlsx")) %>% 
  clean_names()

# ---lu change---
# Read in state 2013-2018 change data
state_change_raw <- read.csv(here("Data", "New", "1a_state_percentchange.csv")) %>% 
  clean_names()

#1B
# Read in plantable area data
plantable_raw <- read_xls(here("Data", "New", "1b_Plantable_Area_Final.xls")) %>% 
  clean_names()

# Task 2
#---------------------------------------
# State level 2013 and 2018
frag_state_13_qa <- read_xls(here("Data", "New", "tab_state_13.xls"), range = cell_cols("B:C")) %>% 
  clean_names()

frag_state_18_qa <- read_xls(here("Data", "New", "tab_state_18.xls"), range = cell_cols("B:C")) %>% 
  clean_names()

# County level 2013 and 2018
frag_county_13_qa <- read_xls(here("Data", "New", "tab_county_13.xls"), range = cell_cols("B:G")) %>% 
  clean_names()

frag_county_18_qa <- read_xls(here("Data", "New", "tab_county_18.xls"), range = cell_cols("B:G")) %>% 
  clean_names()


# Task 3
#---------------------------------------
# Riparian tree cover data
riparian_raw <- read.csv(here("Data", "New", "3_riparian_county_2018.csv")) %>% 
  clean_names()

# Figure 28 Outside forest TC change
outside_forest_raw <- read_excel(here("Data", "New", "Forest + Tree Canopy Land Use stats.xlsx"), sheet = "Net forest +TC change") %>% 
  clean_names()

# Figure 29 TC change associated with development
development_change_raw <- read_excel(here("Data", "New", "Land Use Change Analysis - Classes going into and coming out of forests (Data for Sankey Diagrams).xlsx"), sheet =  "Forest + TC to development") %>%
  clean_names()

# Figure 30 Forest transitions to other land covers and uses
forest_transitions_raw <- read_excel(here("Data", "New", "Land Use Change Analysis - Classes going into and coming out of forests (Data for Sankey Diagrams).xlsx"), sheet =  "Forest loss, all causes") %>%
  clean_names()

# Figure 31 Tree cover outside forests transitions to other land covers and uses
tc_transitions_raw <- read_excel(here("Data", "New", "Land Use Change Analysis - Classes going into and coming out of forests (Data for Sankey Diagrams).xlsx"), sheet =  "TC loss, all causes") %>%
  clean_names()

# Figure 32 Tree cover change vs Population growth
growth_vs_change_raw <- read_excel(here("Data", "New", "Forest + Tree Canopy Land Use stats.xlsx"), sheet = "Growth vs Chg Scatterplot") %>% 
  clean_names()

# Task 4
#---------------------------------------
# Read in projected land use change
projected_lu_raw<- read_excel(here("Data", "4_MD_Tech_Study_cz_2021_20210929.xlsx"), sheet = 3) %>% 
  clean_names() %>% 
  mutate(cntyname = str_to_title(cntyname)) # change counties from all caps to sentence case

# Read in state timber data
md_timber_raw <- read.csv(here("Data", "New", "4_MD_Timber.csv")) %>% 
  clean_names() %>% 
  mutate(county = str_squish(county)) # remove white space

#---------------------------------------
# Color  Palettes
#---------------------------------------
lu_palette <- c(
  "Tree Canopy" = "#6eb663", # Forest Canopy, green
  "Low Vegetation" = "#AFD2AA", # Low veg, light green
  "Water" = "#4059AD", # Water, royal blue
  "Impervious" = "#F08701", # Impervious, orange 
  "Wetland" = "#21A0A0", # Wetland, Blue-green
  "Road" = "#F9A620", # Roads, light orange
  "Structures" = "#D9682A", # Buildings/Structures, brick
  "Barren" = "#F9DB6D", # Barren, light yellow
  "Shrub" = "#8CC8B5" # Shrub,light green-blue
)

# Categorical County Color Palette
county_pallette <- c("Allegany" = "#68affc",
                           "Anne Arundel" = "#485172",
                           "Baltimore" = "#d6a7f0", 
                           "Baltimore City" = "#7c46a0",
                           "Calvert" = "#20d8fd", 
                           "Caroline" = "#155126", 
                           "Carroll" = "#a2e84f", 
                           "Cecil" = "#528f7a", 
                           "Charles" = "#7dd9a0",
                           "Dorchester" = "#39970e", 
                           "Frederick" = "#d0d9ae", 
                           "Garrett" = "#e27040", 
                           "Harford" = "#f29180", 
                           "Howard" = "#e13224", 
                           "Kent" = "#922d4c", 
                           "Montgomery" = "#d9c937", 
                           "Prince George's" = "#fa217f",
                           "Queen Anne's" = "#36f459", 
                           "St. Mary's" = "#b825af", 
                           "Somerset" = "#f27ff5", 
                           "Talbot" = "#fda547", 
                           "Washington" = "#b7358d", 
                           "Wicomico" = "#a1e8af", 
                           "Worcester" = "#7e52a0")

# Fig 29 Development Change Palette
development_palette <- c(
  "forest_to_developed" = "#F08701",
  "tree_canopy_to_developed" = "#F9A620",
  "developed_to_forest" = "#24693d",
  "developed_to_tree_canopy" = "#6eb663"
)

# Fig 30 Forest Transition Palette
forest_transition_palette <- c(
  "Forest To Tree Canopy" = "#6eb663",
  "Forest To Developed" = "#F08701",
  "Forest To Natural" = "#498D43",
  "Forest To Production Ag Extractive" = "#97CC04",
  "Forest To Wetlands" = "#21A0A0",
  "Forest To Water" = "#4059AD"
)

# Fig 31 Tree canopy Transition Palette
tc_transition_palette <- c(
  "Tree Canopy To Forest" = "#24693d",
  "Tree Canopy To Developed" = "#F08701",
  "Tree Canopy To Natural" = "#498D43",
  "Tree Canopy To Production Ag Extractive" = "#97CC04",
  "Tree Canopy To Wetlands" = "#21A0A0",
  "Tree Canopy To Water" = "#4059AD"
)

#---------------------------------------
# Functions
#---------------------------------------
# Use stringr::str_wrap() to create breaks in long facet titles
stwr <- function(string, nwrap = 15){
  paste(strwrap(string, width = nwrap), collapse = "\n")
}

stwr = Vectorize(stwr)

#---------------------------------------
# Notes
#---------------------------------------
# Standard plot dimensions 7.29 x 4.51 in image

```

### Task 1a. 2018 forest stats

Land use proportion
```{r}
#---------------------------------------
# State level land use
#---------------------------------------
# Get percents 
state_lu_percent <- state_forest_raw %>% 
  select(can_a_acres:apg_a_acres, total_a_acres) %>% 
  pivot_longer(can_a_acres:road_a_acres, names_to = "lu", values_to = "acres") %>% 
  mutate(lu = case_when(
    lu == "can_a_acres" ~ "Tree Canopy",
    lu == "wet_a_acres" ~ "Wetland",
    lu == "low_veg_a_acres" ~ "Low Vegetation",
    lu == "shrub_a_acres" ~ "Shrub",
    lu == "barren_a_acres" ~ "Barren",
    lu == "water_a_acres" ~ "Water",
    lu == "struc_a_acres" ~ "Structures",
    lu == "road_a_acres" ~ "Road",
    lu == "imperv_a_acres" ~ "Impervious")) %>% 
  mutate(percent = acres/total_a_acres,
         label = scales::percent(percent)) %>% 
  mutate(lu = fct_reorder(lu, desc(percent))) %>% 
  select(lu:label) %>% 
  mutate(x2020_pop = 6177224) %>% 
  mutate(county = "Statewide")

#---------------------------------------
# County level land use
#---------------------------------------
# Get percents 
county_lu_percent <- county_forest_raw %>% 
  select(name, can_a_acres:road_a_acres) %>% 
  pivot_longer(can_a_acres:road_a_acres, names_to = "lu", values_to = "acres") %>% 
    mutate(lu = case_when(
    lu == "can_a_acres" ~ "Tree Canopy",
    lu == "wet_a_acres" ~ "Wetland",
    lu == "low_veg_a_acres" ~ "Low Vegetation",
    lu == "shrub_a_acres" ~ "Shrub",
    lu == "barren_a_acres" ~ "Barren",
    lu == "water_a_acres" ~ "Water",
    lu == "struc_a_acres" ~ "Structures",
    lu == "road_a_acres" ~ "Road",
    lu == "imperv_a_acres" ~ "Impervious",
    lu == "apg_a_acres" ~ "Aberdeen Proving Ground")) %>% 
  group_by(name) %>% 
  mutate(percent = acres/sum(acres)) %>% 
  mutate(percent = acres/sum(acres),
         label = scales::percent(percent, accuracy = 1)) %>% # labels for county percent plot
  rename(county = name)

# Ordered by population
#---------------------------------------
# Join county and population data
county_percent_pop <- full_join(county_lu_percent, county_pop, by = "county")

#---------------------------------------
# Stacked bar plot lu percent area state and county
#---------------------------------------
# Merge state and county dfs
state_county_merge <- rbind(state_lu_percent, county_percent_pop) %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop)) %>% 
  select(county, everything())

#---------------------------------------
# Plot
#---------------------------------------
fig_5 <- ggplot(data = state_county_merge, aes(x = county, y = percent, fill = lu)) +
  geom_bar(position = "fill", stat = "identity") +
    labs(
#    title = "2018 Land Use Proportions by Jurisdiction",
    x = "Jurisdiction",
    y = "Percent Cover") +
  scale_y_continuous(labels = percent) +
  scale_fill_manual(values = lu_palette) +
    theme_minimal() +
  theme(
#    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    legend.title = element_text(size = 14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  ) +
  guides(fill = guide_legend(title = "Land Cover Type")) +
  coord_flip()

fig_5

ggsave(here("Graphics", "fig5_state_county_lu.jpeg"), fig_5)

```

Percent tree canopy by county
```{r}
#---------------------------------------
# 2018 Percent Tree Canopy by County
#---------------------------------------
# Get tree cover by county
county_tree_cover <- county_lu_percent %>% 
  filter(lu == "Tree Canopy")

# Plot
#---------------------------------------
ggplot(data = county_tree_cover, aes(x = fct_rev(county), y = percent)) +
  geom_col(aes(fill = county)) +
  geom_text(aes(label = label,
                color = county,
                hjust = -0.1),
            size = 3) +
  scale_fill_manual(values = county_pallette) +
  scale_color_manual(values = county_pallette) +
  scale_y_continuous(breaks = c(0, 0.20, 0.40, 0.60, 0.80),
                     labels = c("0%", "20%", "40%", "60%", "80%")) +
  labs(
 #   title = "Percent Tree Canopy by Jurisdiction 2018",
    x = "Jurisdiction",
    y = "Percent Tree Canopy"
  ) +
  coord_flip() +
  theme_minimal() +
  theme(
    legend.position = "none",
#    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

#---------------------------------------
# 2018 Percent Tree Canopy by County Inside vs Outside Forest
#---------------------------------------
county_tc_forest <- county_tc_forest_raw %>% 
  mutate(fore_pc_calc = forest_ac/jurisdicti) %>% # Calculate percent in forest
  mutate(tc_pc_calc = tc_out_fore/jurisdicti) %>% # Calculate percent out of forest
  select(name, fore_pc_calc, tc_pc_calc) %>% 
  pivot_longer(!name, 
               names_to = "type",
               values_to = "percent") %>% 
        mutate(type = case_when(
    type == "fore_pc_calc" ~ "Inside Forest",
    type == "tc_pc_calc" ~ "Outside Forest")) %>% 
  rename(county = name)

# Join population to county inside/outside forest data
county_tc_pop <- full_join(county_tc_forest, county_pop, by = "county") %>% 
  mutate(type = as.factor(type)) %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop)) # order by population (largest to smallest)

# Plot
#---------------------------------------
fig_4 <- ggplot(data = county_tc_pop, aes(x = county, y = percent)) +
  geom_col(aes(fill = type)) +
  scale_fill_manual(values = c("#24693d", "#6eb663")) +
  scale_y_continuous(labels = percent) +
  labs(
    x = "Jurisdiction",
    y = "Percent Tree Canopy Cover"
  ) +
  coord_flip() +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_4
 
ggsave(here("Graphics", "fig4_county_lu.jpg"), fig_4)
```

Land use change at the state level

```{r}
#---------------------------------------
# State Land Use Change 2013 to 2018
#---------------------------------------

# Acres Change (Normalized)
#---------------------------------------
# Get area for each year
state_lu_2013 <- state_change_raw %>% 
  select(x2013_water_a:x2013_road_a) %>% 
  pivot_longer(x2013_water_a:x2013_road_a, 
               names_to = "lu",
               values_to = "lu_2013_m") %>% 
  mutate(lu = case_when(
    lu == "x2013_water_a" ~ "Water",
    lu == "x2013_wet_a" ~ "Wetland",
    lu == "x2013_can_a" ~ "Tree Canopy",
    lu == "x2013_shrub_a" ~ "Shrub",
    lu == "x2013_low_veg_a" ~ "Low Vegetation",
    lu == "x2013_barren_a" ~ "Barren",
    lu == "x2013_struc_a" ~ "Structures",
    lu == "x2013_imperv_a" ~ "Impervious",
    lu == "x2013_road_a" ~ "Road"))

state_lu_2018 <- state_change_raw %>% 
  select(water_a:road_a) %>% 
  pivot_longer(water_a:road_a,
               names_to = "lu",
               values_to = "lu_2018_m") %>% 
    mutate(lu = case_when(
    lu == "water_a" ~ "Water",
    lu == "wet_a" ~ "Wetland",
    lu == "can_a" ~ "Tree Canopy",
    lu == "shrub_a" ~ "Shrub",
    lu == "low_veg_a" ~ "Low Vegetation",
    lu == "barren_a" ~ "Barren",
    lu == "struc_a" ~ "Structures",
    lu == "imperv_a" ~ "Impervious",
    lu == "road_a" ~ "Road"))

# Area change 2013 to 2018
#---------------------------------------
# bind back together, convert meters to acres, calculate area change
state_lu_acres <- left_join(state_lu_2013, state_lu_2018) %>% 
  mutate(lu_2013_acres = lu_2013_m*0.000247105) %>% 
  mutate(lu_2018_acres = lu_2018_m*0.000247105) %>% 
  mutate(acres_change = lu_2018_acres-lu_2013_acres) %>% 
  mutate(acres_change_std = acres_change/25914854725) %>% # divide by total area
  mutate(lu = fct_reorder(lu, desc(acres_change_std)))

# Make tidy with year variable
state_lu_long <- state_lu_acres %>% 
  select(lu, lu_2013_acres, lu_2018_acres) %>% 
  pivot_longer(lu_2013_acres:lu_2018_acres, 
               names_to = "year",
               values_to = "tot_acres") %>% 
  mutate(year = case_when(
    year == "lu_2013_acres" ~ "2013",
    year == "lu_2018_acres" ~ "2018"))

# Gain and loss labels
state_lu_change <- state_lu_acres %>% 
      mutate(net = case_when(
     acres_change >= 0 ~ "Gain",
     acres_change < 0 ~ "Loss"
   )) %>% 
  mutate(acres_change = round(acres_change, digits = 0)) %>% 
  mutate(year = "2013") %>% # prepare for merge so only one set remains
  mutate(acres_change = sprintf("%+d", acres_change)) %>%  # Add + to positive values
  select(lu, year, acres_change, net)

# Merge back together
state_change_full <- full_join(state_lu_long, state_lu_change) %>% 
  mutate(lu = fct_reorder(lu, desc(acres_change))) 

# Figure 25
#---------------------------------------
fig_25 <- ggplot(data = state_change_full, aes(x = lu, y = tot_acres)) +
  geom_bar(aes(fill = year), position="dodge", stat="identity") +
  geom_text(aes(label = acres_change, color = net, vjust = -0.5)) +
  scale_fill_manual(values = c("gray70", "gray40")) +
  scale_color_manual(values = c("#498D43", "red")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    x = "Land Cover Class",
    y = "Total Area (Acres)"
  ) +
  theme_minimal() +
  coord_cartesian(clip = "off") +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  ) +
  guides(color = "none")

fig_25

ggsave(here("Graphics", "fig25_state_lu_change.jpg"), fig_25, height = 5, width = 9)


```

Land use change at the county level

```{r}
#---------------------------------------
# 2013-2018 Land Use by County
#---------------------------------------
# Get 2013 lu by county
county_lu_2013 <- county_forest_raw %>% 
  select(name:x2013_road_a) %>% 
  pivot_longer(!name, names_to = "lu", values_to = "lu_2013_m") %>% 
    mutate(lu = case_when(
    lu == "x2013_water_a" ~ "Water",
    lu == "x2013_wet_a" ~ "Wetland",
    lu == "x2013_can_a" ~ "Tree Canopy",
    lu == "x2013_shrub_a" ~ "Shrub",
    lu == "x2013_low_veg_a" ~ "Low Vegetation",
    lu == "x2013_barren_a" ~ "Barren",
    lu == "x2013_struc_a" ~ "Structures",
    lu == "x2013_imperv_a" ~ "Impervious",
    lu == "x2013_road_a" ~ "Road"))

# Get 2018 lu by county 
county_lu_2018 <- county_forest_raw %>% 
  select(name, water_a:road_a) %>% 
  pivot_longer(!name, names_to = "lu", values_to = "lu_2018_m") %>% 
      mutate(lu = case_when(
    lu == "water_a" ~ "Water",
    lu == "wet_a" ~ "Wetland",
    lu == "tc_a" ~ "Tree Canopy",
    lu == "shrub_a" ~ "Shrub",
    lu == "low_veg_a" ~ "Low Vegetation",
    lu == "barren_a" ~ "Barren",
    lu == "struc_a" ~ "Structures",
    lu == "imperv_a" ~ "Impervious",
    lu == "road_a" ~ "Road"))

# Bind back together, get area in acres, calculate change
county_lu_change <- left_join(county_lu_2013, county_lu_2018) %>% 
  mutate(lu_2013_acres = lu_2013_m*0.000247105) %>% 
  mutate(lu_2018_acres = lu_2018_m*0.000247105) %>% 
  mutate(acres_change = lu_2018_acres-lu_2013_acres)

# Plot
#---------------------------------------
fig_27 <- ggplot(data = county_lu_change, aes(x = lu, y = acres_change)) +
  geom_col(aes(fill = lu)) +
  facet_wrap(~name, scales = "free") +
  scale_fill_manual(values = lu_palette) +
  labs(
    x = "Land Cover Class",
    y = "Area Change (Acres)"
  ) +
  scale_y_continuous(labels=comma_format()) +
  theme_minimal() +
  geom_hline(aes(yintercept=0)) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.background = element_rect(color = "grey40", fill = "grey30"),
    strip.text = element_text(color = "white", face = "bold"),
    panel.border = element_rect(color = "grey40", fill = NA),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_27

ggsave(here("Graphics", "fig27_county_lu_change.jpg"), fig_27, height = 7.5, width = 8)

#---------------------------------------
# County land cover change tables for Jessica
#---------------------------------------
county_change_table <- county_lu_change %>% 
  select(name, lu, lu_2013_acres:acres_change) %>% 
  rename(county = name) %>% 
  rename(land_cover = lu) %>% 
  rename(acres_2013 = lu_2013_acres) %>% 
  rename(acres_2018 = lu_2018_acres)

# Group land cover change by region
county_change_grouped_table <- county_change_table %>% 
  mutate(region = case_when(
    county %in% c("Garrett", "Allegany", "Washington") ~ "Western",
    county %in% c("Carroll", "Baltimore", "Baltimore City", "Harford") ~ "North Central",
    county %in% c("Montgomery", "Howard", "Anne Arundel", "Prince George's", "Frederick") ~ "Central",
    county %in% c("Calvert", "Charles", "St. Mary's") ~ "Southern",
    county %in% c("Cecil", "Kent", "Queen Anne's", "Caroline", "Talbot", "Dorchester") ~ "Upper Eastern",
    county %in% c("Wicomico", "Somerset", "Worcester") ~ "Lower Eastern")) %>% 
group_by(region, land_cover) %>% 
  summarise(across(c("acres_2013", "acres_2018","acres_change"), funs(sum)))

# Export to excel
write.xlsx(as.data.frame(county_change_tables), file.path("Tables", file = "Fig27_Table_LC_Change.xlsx") , sheet = "county", row.names = FALSE)

write.xlsx(as.data.frame(county_change_grouped_table), file.path("Tables", file = "Fig27_Table_LC_Change.xlsx"), sheet = "region", append = TRUE, row.names = FALSE)

```
### Task 1b. Plantable Area

# Acres plantable area by jurisdiction

```{r}
#---------------------------------------
# Plantable area
#---------------------------------------
plantable_area <- plantable_raw %>% 
  select(name, plantable_ac) %>% 
  rename(county = name)

# Ordered by population
#---------------------------------------
# Join plantable area and population data
plantable_area_pop <- full_join(plantable_area, county_pop, by = "county") %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop))

#---------------------------------------
# Plot Plantable Area
#---------------------------------------
fig_6 <- ggplot(data = plantable_area, aes(x = fct_rev(county), y = plantable_ac)) +
  geom_col(aes(fill = county)) +
  labs(x = "Jurisdiction", 
       y = "Total Area (Acres)") +
  scale_fill_manual(values = county_pallette) +
# scale_fill_manual(values = rep(c("#78b98f", "#453e7d", "#c1c2f5", "#1b511d", "#8fc86c", "#aedddd"),4)) +
  scale_y_continuous(labels = comma_format()) +
  coord_flip() +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_6

ggsave(here("Graphics", "fig6_plantable_area.jpg"), fig_6, height = 4.5, width = 7.29)

 
```

# Percent plantable area by jurisdiction

```{r}
#---------------------------------------
# Percent plantable area by exclusion zone
#---------------------------------------
plantable_percent <- plantable_raw %>% 
  select(name, lc_plantable_ac, lulc_plantable_ac, plantable_ac, jurisdiction_ac) %>% 
  mutate(lc_p = lc_plantable_ac/jurisdiction_ac) %>% 
  mutate(lulc_p = lulc_plantable_ac/jurisdiction_ac) %>% 
  mutate(plantable_p = plantable_ac/jurisdiction_ac) %>% 
  mutate(lc_stack = lc_p - lulc_p) %>% 
  mutate(lulc_stack = lulc_p - plantable_p) %>%
  select(name, plantable_p, lulc_stack, lc_stack) %>%
  pivot_longer(!name, names_to = "type", values_to = "percent") %>% 
  mutate(type = case_when(
    type == "lc_stack" ~ "LC",
    type == "lulc_stack" ~ "LU/LC",
    type == "plantable_p" ~ "Plantable Area"
    )) %>% 
  mutate(type = as.factor(type)) %>% 
  mutate(type = fct_relevel(type, "LC", "LU/LC", "Plantable Area")) %>% 
  rename(county = name)

# Ordered by population
#---------------------------------------
# Join plantable percent and population data
plantable_percent_pop <- full_join(plantable_percent, county_pop, by = "county") %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop))

#---------------------------------------
# Plot plantable percent
#---------------------------------------
ggplot(data = plantable_percent, aes(x = fct_rev(county), y = percent)) +
  geom_col(aes(fill = type)) +
  scale_fill_manual(values = c("#85D5A3", # Lightest Green
                               "#3EB66A", # Lighter Green
                               "#24693d")) + # Dark Green
  scale_y_continuous(labels = percent) +
  labs(
    x = "Jurisdiction",
    y = "Percent of Jurisdiction Land Area"
  ) +
  coord_flip() +
  theme_minimal() +
    theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

# ggsave(here("Graphics", "fig7_plantable_percent.jpg"), fig_7, width = 7.29, height = 4.5)

```

Percent plantable area by jurisdiction

```{r}
#---------------------------------------
# Percent Plantable grouped by Region
#---------------------------------------
plantable_group <- plantable_raw %>% 
  mutate(region = case_when(
    name %in% c("Garrett", "Allegany", "Washington") ~ "Western",
    name %in% c("Carroll", "Baltimore", "Baltimore City", "Harford") ~ "North Central",
    name %in% c("Montgomery", "Howard", "Anne Arundel", "Prince George's", "Frederick") ~ "Central",
    name %in% c("Calvert", "Charles", "St. Mary's") ~ "Southern",
    name %in% c("Cecil", "Kent", "Queen Anne's", "Caroline", "Talbot", "Dorchester") ~ "Upper Eastern",
    name %in% c("Wicomico", "Somerset", "Worcester") ~ "Lower Eastern")) %>% 
  select(name, region, lc_plantable_ac, lulc_plantable_ac, plantable_ac, jurisdiction_ac) %>% 
  group_by(region) %>% 
  summarise(across(where(is.numeric), sum)) %>% 
    mutate(lc_p = lc_plantable_ac/jurisdiction_ac) %>% 
  mutate(lulc_p = lulc_plantable_ac/jurisdiction_ac) %>% 
  mutate(plantable_p = plantable_ac/jurisdiction_ac) %>% 
  mutate(lc_stack = lc_p - lulc_p) %>% 
  mutate(lulc_stack = lulc_p - plantable_p) %>% 
  select(region, plantable_p, lulc_stack, lc_stack) %>%
  pivot_longer(!region, names_to = "type", values_to = "percent") %>% 
  mutate(type = case_when(
    type == "lc_stack" ~ "LC",
    type == "lulc_stack" ~ "LU/LC",
    type == "plantable_p" ~ "Plantable Area"
    )) %>% 
  mutate(type = as.factor(type)) %>% 
  mutate(type = fct_relevel(type, "LC", "LU/LC", "Plantable Area")) %>% 
  mutate(region = as.factor(region)) %>% 
  mutate(region = fct_relevel(region, "Western", "North Central", "Central", "Southern", "Upper Eastern", "Lower Eastern"))

#---------------------------------------
# Plot grouped plantable percent
#---------------------------------------
fig_7 <- ggplot(data = plantable_group, aes(x = region, y = percent)) +
  geom_col(aes(fill = type)) +
  scale_fill_manual(values = c("#85D5A3", # Lightest Green
                               "#3EB66A", # Lighter Green
                               "#24693d")) + # Dark Green
  scale_y_continuous(labels = percent) +
  labs(
    x = "Jurisdiction",
    y = "Percent of Jurisdiction Land Area"
  ) +
  coord_flip() +
  theme_minimal() +
    theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_7

ggsave(here("Graphics", "fig7_plantable_percent.svg"), fig_7)

```


### Task 2 Forest Health

Forest fragmentation at the state level

```{r}
#---------------------------------------
# State Fragmentation Area
#---------------------------------------
# 2013 state
frag_state_13 <- frag_state_13_qa %>% 
  rename(area_acres = area) %>% 
  mutate(year = "2013") %>% 
  select(value, year, area_acres)
  
# 2018 state
frag_state_18 <- frag_state_18_qa %>% 
  rename(area_acres = area) %>% 
  mutate(year = "2018") %>% 
  select(value, year, area_acres)

# Join years together
frag_state_merge <- full_join(frag_state_13, frag_state_18) %>% 
  rename(frag_type = value) %>% 
  mutate(frag_type = case_when( 
    frag_type == "1" ~ "Isolated Patch",
    frag_type == "2" ~ "Edge",
    frag_type == "4" ~ "Small Core",
    frag_type == "5" ~ "Medium Core",
    frag_type == "6" ~ "Large Core",
  ))

# Get difference between 2013 and 2018
frag_state_diff <- frag_state_merge %>% 
  mutate(year = case_when( 
    year == "2013" ~ "area_2013",
    year == "2018" ~ "area_2018"
  )) %>% 
  pivot_wider(names_from = year, values_from = area_acres) %>% 
  mutate(area_diff = area_2018 - area_2013) %>% 
  mutate(year = "2013") %>% # Prepare so only one set comes through on merge
  select(frag_type, year, area_diff)

# Full set with difference labels
frag_state_full <- full_join(frag_state_merge, frag_state_diff) %>% 
  mutate(area_diff = round(area_diff, digits = 0)) %>% 
  mutate(net = case_when(
    area_diff > 0 ~ "Gain",
    area_diff < 0 ~ "Loss"
  )) %>% 
  mutate(area_diff = sprintf("%+d", area_diff)) %>% # Add + to positive values
  replace_with_na(replace = list(area_diff = "NA")) %>%  # Fix NA values that sprintf converted
  mutate(frag_type = as.factor(frag_type)) %>% 
  mutate(frag_type = fct_relevel(frag_type,
                              "Isolated Patch",
                              "Edge",
                              "Small Core",
                              "Medium Core",
                              "Large Core"
                              ))
# Plot
#---------------------------------------
fig_10 <- ggplot(data = frag_state_full, aes(x = frag_type, y = area_acres, label = area_diff)) +
  geom_col(aes(fill = year), position = "dodge") +
#  scale_fill_manual(values = c("#6eb663", "#24693d")) +
  scale_fill_manual(values = c("gray70", "gray40")) +
  geom_text(aes(color = net), vjust = -0.5) +
  scale_color_manual(values = c("#498D43", "red")) +
  labs(
    #  title = "Forest Fragment Type Area in 2013 and 2018",
       x = "Forest Fragment Type",
       y = "Total Area (Acres)") +
  scale_y_continuous(labels=comma_format()) +
  theme_minimal() +
  coord_cartesian(clip = "off") +
  theme(
    axis.title.x = element_blank(),
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", margin = margin(t = 0, r = 10, b = 0, l = 0)),
    legend.position = "bottom",
    legend.title.align = 0.5,
    legend.title = element_text(size = 14, face = "bold"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA),
  ) +
  guides(color = "none",
         fill = guide_legend(title = "Year", 
                             title.position = "top"))

fig_10

ggsave(here("Graphics", "fig10_state_fragmentation.jpg"), fig_10)

```
Forest Fragmentation at the county level

```{r}
#---------------------------------------
# County Fragmentation Area
#---------------------------------------
# 2013 County
frag_county_13 <- frag_county_13_qa %>% 
  pivot_longer(!name, names_to = "frag_type", values_to = "acres_2013")

# 2018 County
frag_county_18 <- frag_county_18_qa %>% 
  pivot_longer(!name, names_to = "frag_type", values_to = "acres_2018")

# Join years together
frag_county_full <- full_join(frag_county_13, frag_county_18) %>% 
  mutate(frag_type = case_when(
    frag_type == "value_1" ~ "Isolated Patch",
    frag_type == "value_2" ~ "Edge",
    frag_type == "value_4" ~ "Small Core",
    frag_type == "value_5" ~ "Medium Core",
    frag_type == "value_6" ~ "Large Core",
  )) %>%
  mutate(acres_change = acres_2018 - acres_2013) %>% 
  rename(county = name)

# Ordered by population
#---------------------------------------
# Join population data
frag_county_pop <- full_join(frag_county_full, county_pop, by = "county") %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop))
  
# Plot
#---------------------------------------
fig_11 <- ggplot(data = frag_county_full, aes(x = county, y = acres_change)) +
  geom_col(aes(fill = county)) +
  scale_fill_manual(values = county_pallette) +
    labs(
      #title = "Forest Fragment Type Area Change \n from 2013 to 2018",
       y = "Area (acres)") +
  theme_minimal() +
  geom_hline(aes(yintercept=0)) +
  facet_wrap(~frag_type, scale = "free_y") +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0), size = 14, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.position = "bottom",
    legend.title.align = 0.5,
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA),
    strip.background = element_rect(color = "grey40", fill = "grey30"),
    strip.text = element_text(size = 12, color = "white", face = "bold"),
    panel.border = element_rect(color = "grey40", fill = NA)
   ) +
    guides(fill = guide_legend(title = "Jurisdiction",
                               title.position = "top",
                               nrow = 4)) +
  scale_y_continuous(labels=comma_format())

fig_11

ggsave(here("Graphics", "fig11_county_fragmentation.jpg"), fig_11, height = 4.5, width = 8)

```

### Task 3 Urban Change

Percent tree canopy in riparian buffer zone by jurisdiction

```{r}
#---------------------------------------
# Riparian buffer tree canopy
#---------------------------------------

# Calc percent and Create new variable: above or below threshold
riparian_buffer <- riparian_raw %>% 
  select(name, can_a, total_a) %>% 
  mutate(can_p_calc = can_a/total_a,
         label = scales::percent(can_p_calc, accuracy = 1)) %>% 
  mutate(threshold = case_when(
     label >= 70 ~ "Meets Goal",
     label < 70 ~ "Does Not Meet Goal"
   )) %>% 
  rename(county = name)

# Ordered by population
#---------------------------------------
# Join riparian and population data
riparian_buffer_pop <- full_join(riparian_buffer, county_pop, by = "county") %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop)) # order by population (largest to smallest)

#---------------------------------------
# Plot
#---------------------------------------
ggplot(data = riparian_buffer_pop, aes(x = county, y = can_p_calc)) +
  geom_col(aes(fill = threshold)) +
  scale_fill_manual(values = c("#c3dbcb", "seagreen4")) +
  labs(
#    title = "Riparian Buffer Percent Tree Canopy",
    x = "Jurisdiction",
    y = "Percent Tree Canopy Over Riparian Buffer Area") +
  geom_text(label = "70%",
            color = "red",
            face = "bold",
            vjust = 2.65,
            aes(x = "Kent", y = 0.70)) +
  geom_hline(aes(yintercept = 0.70), linetype = "dashed",
            color = "red",
            size = 1) +
  geom_text(aes(label = label,
                hjust = -0.1),
            size = 3) +
  scale_y_continuous(labels = percent) +
  coord_flip(clip = "off") +
  theme_minimal() +
  theme(
#    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

# Without threshold
fig_16 <- ggplot(data = riparian_buffer, aes(x = fct_rev(county), y = can_p_calc)) +
  geom_col(aes(fill = county)) +
  scale_fill_manual(values = county_pallette) +
  labs(
    x = "Jurisdiction",
    y = "Percent Tree Canopy Over Riparian Buffer Area") +
    geom_text(aes(label = label,
                hjust = -0.1),
            size = 3) +
  scale_y_continuous(labels = percent) +
  coord_flip(clip = "off") +
  theme_minimal() +
  theme(
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    legend.position = "none",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_16
 
ggsave(here("Graphics", "fig16_riparian.jpg"), fig_16)

```

Net change in the extent of forest and tree canopy outside of forest land use, by jurisdiction (acres).

```{r}
#---------------------------------------
# Riparian buffer tree canopy
#---------------------------------------
outside_forest <- outside_forest_raw %>% 
  pivot_longer(!county_jurisdiction_name, names_to = "type", values_to = "acres_change")

# Plot
#---------------------------------------
fig_28 <- ggplot(data = outside_forest, aes(x = fct_rev(county_jurisdiction_name), y = acres_change)) +
  geom_col(aes(fill = type), position = "dodge") +
  scale_fill_discrete(labels=c("Net Forest Change", "Net TC Outside Forest Change")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    x = "Jurisdiction",
    y = "Change in Area (Acres)"
  ) +
  coord_flip() +
  theme_minimal() +
  geom_hline(aes(yintercept=0)) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_28

ggsave(here("Graphics", "fig28_outside_forest_change.jpg"), fig_28)

```
Total forest and total tree canopy land use loss and gain associated with development (acres).
```{r}
#---------------------------------------
# Forest and Tree Canopy Change Associated with Development
#---------------------------------------
development_change <- development_change_raw %>% 
  select(county_jurisdiction_name:tree_canopy_to_developed, developed_to_forest, developed_to_tree_canopy) %>% 
  pivot_longer(!county_jurisdiction_name, names_to = "type", values_to = "acres_change") %>% 
  drop_na()

# Plot
#---------------------------------------
fig_29 <- ggplot(data = development_change, aes(x = fct_rev(county_jurisdiction_name), y = acres_change)) +
  geom_col(aes(fill = type)) +
  scale_fill_manual(values = development_palette,
                    labels=c("developed_to_forest" = "Developed to Forest", 
                             "developed_to_tree_canopy" = "Developed to Tree Canopy",
                             "forest_to_developed" = "Forest to Developed", 
                             "tree_canopy_to_developed" = "Tree Canopy to Developed")) +
  scale_y_continuous(labels = comma_format()) +
  labs(
    x = "Jurisdiction",
    y = "Change in Area (Acres)"
  ) +
  coord_flip() +
  theme_minimal() +
  geom_hline(aes(yintercept=0)) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  ) +
  guides(fill = guide_legend(nrow = 2))

fig_29

ggsave(here("Graphics", "fig29_development_tc_change.jpg"), fig_29)

```
Forest transitions to other land covers and uses

```{r}
#---------------------------------------
# Forest change to other land uses
#---------------------------------------
forest_transitions <- forest_transitions_raw %>% 
  select(county_jurisdiction_name, forest_to_tree_canopy:forest_to_water) %>% 
  pivot_longer(!county_jurisdiction_name, names_to = "transition", values_to = "acres_change") %>% 
  mutate(transition = str_replace_all(transition, "_", " ")) %>% 
  mutate(transition = str_to_title(transition)) %>% 
  mutate(transition = fct_relevel(transition, 
                                  "Forest To Water",
                                  "Forest To Wetlands",
                                  "Forest To Tree Canopy",
                                  "Forest To Natural",
                                  "Forest To Production Ag Extractive",
                                  "Forest To Developed"
                                  ))

# Plot
#---------------------------------------
fig_30 <- ggplot(data = forest_transitions, aes(x = fct_rev(county_jurisdiction_name), y = acres_change)) +
  geom_col(aes(fill = transition)) +
  scale_fill_manual(values = forest_transition_palette) +
  labs(
    x = "Jurisdiction",
    y = "Transition Area (Acres)"
  ) +
  scale_y_continuous(labels = comma_format()) +
  coord_flip() +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_30

ggsave(here("Graphics", "fig30_forest_transitions.jpg"), fig_30)

```
Area of Tree Canopy Outside Forest Converted to Other Land Use Classes (acres)

```{r}
#---------------------------------------
# Tree cover outside forests transitions to other land covers and uses 
#---------------------------------------
tc_transitions <- tc_transitions_raw %>% 
  select(county_jurisdiction_name, tree_canopy_to_forest:tree_canopy_to_water) %>% 
  pivot_longer(!county_jurisdiction_name, names_to = "transition", values_to = "acres_change") %>% 
  mutate(transition = str_replace_all(transition, "_", " ")) %>% 
  mutate(transition = str_to_title(transition)) %>% 
  mutate(transition = fct_relevel(transition, 
                                  "Tree Canopy To Water",
                                  "Tree Canopy To Wetlands",
                                  "Tree Canopy To Forest",
                                  "Tree Canopy To Natural",
                                  "Tree Canopy To Production Ag Extractive",
                                  "Tree Canopy To Developed"
                                  ))

# Plot
#---------------------------------------
fig_31 <- ggplot(data = tc_transitions, aes(x = fct_rev(county_jurisdiction_name), y = acres_change)) +
  geom_col(aes(fill = transition)) +
  scale_fill_manual(values = tc_transition_palette) +
  labs(
    x = "Jurisdiction",
    y = "Transition Area (Acres)"
  ) +
  coord_flip() +
  theme_minimal() +
  scale_y_continuous(labels = comma_format()) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_31

ggsave(here("Graphics", "fig31_tc_transitions.jpg"), fig_31)

```
Net percent change in forest and tree canopy outside forest by jurisdictional population growth rate, 2010-2020.

```{r}
#---------------------------------------
# Percent tree canopy change vs population growth
#---------------------------------------
growth_vs_change <- growth_vs_change_raw %>% 
  select(county_jurisdiction, net_change_percent, growth_rate) %>% 
  mutate(county_jurisdiction = str_replace_all(county_jurisdiction, " County", "")) %>% 
  mutate(region = case_when(
    county_jurisdiction %in% c("Garrett", "Allegany", "Washington") ~ "Western",
    county_jurisdiction %in% c("Carroll", "Baltimore", "Baltimore City", "Harford") ~ "North Central",
    county_jurisdiction %in% c("Montgomery", "Howard", "Anne Arundel", "Prince George's", "Frederick") ~ "Central",
    county_jurisdiction %in% c("Calvert", "Charles", "St. Mary's") ~ "Southern",
    county_jurisdiction %in% c("Cecil", "Kent", "Queen Anne's", "Caroline", "Talbot", "Dorchester") ~ "Upper Eastern",
    county_jurisdiction %in% c("Wicomico", "Somerset", "Worcester") ~ "Lower Eastern"))

# Plot
#---------------------------------------
fig_32 <- ggplot(data = growth_vs_change, aes(x = growth_rate, y = net_change_percent)) +
  geom_point(aes(color = region)) +
  geom_text_repel(aes(label = county_jurisdiction), size = 3) +
  scale_y_continuous(labels = percent) +
  labs(
    x = "Population growth rate (2010-2020)",
    y = "Net percent change in forest \n and tree canopy outside forest"
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  geom_hline(aes(yintercept = 0), alpha = 0.4) +
  geom_vline(aes(xintercept = 0), alpha = 0.4) +
  theme(
    legend.position = "bottom",
    legend.title.align = 0.5,
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  ) +
    guides(color = guide_legend(title = "Region", 
                             title.position = "top",
                             nrow = 1))

fig_32

ggsave(here("Graphics", "fig32_growth_vs_change.jpg"), fig_32)

```


### Task 4 Projected Land Use

Projected land use 2025 and 2055

```{r}
#---------------------------------------
# Projected land use by land use type and county
#---------------------------------------
projected_lu <- projected_lu_raw %>% 
  pivot_longer(!fips:cntyname, names_to = "land_use", values_to = "acres") %>% 
  rename(county = cntyname) %>% 
  mutate(county = str_replace(county, "Prince Georges", "Prince George's")) %>% # Fix county names with apostrophes so they match population data
  mutate(county = str_replace(county, "Queen Annes", "Queen Anne's")) %>%  
  mutate(county = str_replace(county, "St Marys", "St. Mary's")) %>%
    mutate(full_name = case_when(
    land_use == "ir_chg" ~ "Impervious Roads",
    land_use == "inr_chg" ~ "Impervious Non-Roads",
    land_use == "tci_chg" ~ "Tree Canopy Over Impervious",
    land_use == "tg_chg" ~ "Turf Grass",
    land_use == "tct_chg" ~ "Tree Canopy over Turf Grass",
    land_use == "fore_chg" ~ "Forest",
    land_use == "wlo_chg" ~ "Wetlands (Other)",
    land_use == "wlf_chg" ~ "Wetlands (Floodplain)",
#    land_use == "wat_chg" ~ "Water", # Model not run for water and wetland
    land_use == "mo_chg" ~ "Mixed Open",
    land_use == "crp_chg" ~ "Cropland",
    land_use == "pas_chg" ~ "Pasture",
  )) %>% 
  drop_na()

# Use string wrap function
projected_lu$full_name = stwr(projected_lu$full_name)

# Join population to projected lu
projected_lu_pop <- full_join(projected_lu, county_pop, by = "county") %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop)) # order by population (largest to smallest)


# Plot
#---------------------------------------
fig_35 <- ggplot(projected_lu, aes(x = county, y = acres)) +
  geom_col(aes(fill = county)) +
  scale_fill_manual(values = county_pallette) +
  facet_wrap(~full_name, scales = "free_y") +
  scale_y_continuous(labels = comma_format()) +
  labs(
#    title = "Projected Land Use Change Between 2025 and 2055",
    x = "County", 
    y = "Change in Area (Acres)") +
  theme_minimal() +
   geom_hline(aes(yintercept=0)) +
  theme(
    strip.background = element_rect(color = "grey40", fill = "grey30"),
    strip.text = element_text(color = "white", face = "bold"),
    panel.border = element_rect(color = "grey40", fill = NA),
   legend.title = element_text(size = 14, face = "bold"),
   legend.position = "bottom",
   legend.title.align = 0.5,
   axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)) +
  guides(fill = guide_legend(title = "Jurisdiction", 
                             title.position = "top",
                             nrow = 4))

fig_35

ggsave(here("Graphics", "fig35_projected_lu_change.jpg"), fig_35, height = 6, width = 7.5)

#---------------------------------------
# Projected land use tables for Jessica
#---------------------------------------
# Projected land use by county
projected_lu_table <- projected_lu %>% 
  select(county, full_name, acres) %>% 
  rename(land_use = full_name)

# Projected land use by region
projected_lu_grouped_table <- projected_lu_table %>% 
  mutate(region = case_when(
    county %in% c("Garrett", "Allegany", "Washington") ~ "Western",
    county %in% c("Carroll", "Baltimore", "Baltimore City", "Harford") ~ "North Central",
    county %in% c("Montgomery", "Howard", "Anne Arundel", "Prince George's", "Frederick") ~ "Central",
    county %in% c("Calvert", "Charles", "St. Mary's") ~ "Southern",
    county %in% c("Cecil", "Kent", "Queen Anne's", "Caroline", "Talbot", "Dorchester") ~ "Upper Eastern",
    county %in% c("Wicomico", "Somerset", "Worcester") ~ "Lower Eastern")) %>% 
  group_by(region, land_use) %>% 
  summarise(acres = sum(acres))

# Export to excel
write.xlsx(as.data.frame(projected_lu_table), file.path("Tables", file = "Fig35_Table_Projected_LU.xlsx") , sheet = "county", row.names = FALSE)

write.xlsx(as.data.frame(projected_lu_grouped_table), file.path("Tables", file = "Fig35_Table_Projected_LU.xlsx"), sheet = "region", append = TRUE, row.names = FALSE)

```

Total timber harvest by county 2013 to 2021

```{r}
#---------------------------------------
# Total timber harvest by county
#---------------------------------------

# Get total acres harvested between 2013 and 2021
timber_total <- md_timber_raw %>% 
  group_by(county) %>% 
  summarise(tot_acres = sum(forest_harvest_acres))

# Ordered by population
#---------------------------------------
# Join timber total and population data
timber_pop <- full_join(timber_total, county_pop, by = "county") %>% 
  mutate(county = as.factor(county)) %>% 
  mutate(county = fct_reorder(county, x2020_pop)) # order by population (largest to smallest)

#---------------------------------------
# Plot
#---------------------------------------
fig_21 <- ggplot(data = timber_total, aes(x = fct_rev(county), y = tot_acres)) +
  geom_col(aes(fill = county)) +
 scale_fill_manual(values = county_pallette) +
    # scale_fill_manual(values = rep(c("#78b98f", "#453e7d", "#c1c2f5", "#1b511d", "#8fc86c", "#aedddd"),4)) +
  labs(
#    title = "Total Timber Harvest by Jurisdiction \n between 2013 and 2021",
    x = "Jurisdiction",
    y = "Forest Harvested (Acres)"
  ) +
  scale_y_continuous(labels=comma_format()) +
  coord_flip() +
  theme_minimal() +
  theme(
    legend.position = "none",
#    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 0, r = 10, b = 0, l = 0)),
    axis.title.x = element_text(size = 14,
                                face = "bold",
                                margin = margin(t = 10, r = 0, b = 0, l = 0)),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fig_21

ggsave(here("Graphics", "fig21_timber.jpg"), fig_21)

```

